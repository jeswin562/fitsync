{% extends 'layout.html' %}

{% block title %}AI Fitness Coach{% endblock %}

{% block content %}
<div class="container mt-4">
    <div class="row">
        <!-- AI Coach Chat Interface -->
        <div class="col-lg-8 mx-auto">
            <div class="card animate-in">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <div>
                        <h3 class="mb-0">
                            <i class="fas fa-robot me-2 text-gradient-neon"></i>
                            AI Fitness Coach
                        </h3>
                        <small class="text-muted">Powered by Hugging Face AI</small>
                    </div>
                    <button class="btn btn-sm btn-outline-primary" onclick="clearChat()">
                        <i class="fas fa-trash me-1"></i> Clear Chat
                    </button>
                </div>
                
                <div class="card-body">
                    <!-- Chat Messages Container -->
                    <div id="chat-container" class="chat-messages mb-3">
                        <!-- Welcome Message -->
                        <div class="message bot-message animate-in">
                            <div class="message-avatar">
                                <i class="fas fa-robot"></i>
                            </div>
                            <div class="message-content">
                                <p class="mb-1"><strong>AI Coach</strong> <small class="text-muted">Just now</small></p>
                                <p class="mb-0">
                                    üëã Hey {{ current_user.name or current_user.username }}! I'm your AI fitness coach, powered by advanced AI. 
                                    I'm here to help you with:
                                </p>
                                <ul class="mt-2 mb-0">
                                    <li>üèãÔ∏è Workout plans and exercise advice</li>
                                    <li>ü•ó Nutrition and diet guidance</li>
                                    <li>üí™ Motivation and goal setting</li>
                                    <li>üìä Progress analysis and tips</li>
                                </ul>
                                <p class="mt-2 mb-0">What would you like to know?</p>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Typing Indicator -->
                    <div id="typing-indicator" class="message bot-message" style="display: none;">
                        <div class="message-avatar">
                            <i class="fas fa-robot"></i>
                        </div>
                        <div class="message-content">
                            <div class="typing-dots">
                                <span></span>
                                <span></span>
                                <span></span>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Chat Input Form -->
                    <form id="chat-form" class="mt-3">
                        <div class="input-group">
                            <input 
                                type="text" 
                                id="user-input" 
                                class="form-control" 
                                placeholder="Ask me anything about fitness, nutrition, or workouts..."
                                autocomplete="off"
                                required
                            >
                            <button type="submit" class="btn btn-primary" id="send-btn">
                                <i class="fas fa-paper-plane me-1"></i> Send
                            </button>
                        </div>
                    </form>
                    
                    <!-- Quick Actions -->
                    <div class="quick-actions mt-3">
                        <small class="text-muted d-block mb-2">Quick Questions:</small>
                        <button class="btn btn-sm btn-outline-secondary me-2 mb-2" onclick="askQuestion('What workout should I do today?')">
                            üí™ Workout Suggestion
                        </button>
                        <button class="btn btn-sm btn-outline-secondary me-2 mb-2" onclick="askQuestion('Give me nutrition advice for my goal')">
                            ü•ó Nutrition Tips
                        </button>
                        <button class="btn btn-sm btn-outline-secondary me-2 mb-2" onclick="askQuestion('Motivate me to stay consistent!')">
                            üåü Motivation
                        </button>
                        <button class="btn btn-sm btn-outline-secondary me-2 mb-2" onclick="askQuestion('How can I improve my progress?')">
                            üìä Progress Tips
                        </button>
                    </div>
                </div>
            </div>
            
            <!-- Info Cards -->
            <div class="row mt-4">
                <div class="col-md-4 mb-3">
                    <div class="card text-center">
                        <div class="card-body">
                            <i class="fas fa-brain fa-3x text-gradient-cyan mb-2"></i>
                            <h6>AI-Powered</h6>
                            <p class="small text-muted mb-0">Advanced AI understands your fitness journey</p>
                        </div>
                    </div>
                </div>
                <div class="col-md-4 mb-3">
                    <div class="card text-center">
                        <div class="card-body">
                            <i class="fas fa-user-check fa-3x text-gradient-orange mb-2"></i>
                            <h6>Personalized</h6>
                            <p class="small text-muted mb-0">Advice tailored to your goals and stats</p>
                        </div>
                    </div>
                </div>
                <div class="col-md-4 mb-3">
                    <div class="card text-center">
                        <div class="card-body">
                            <i class="fas fa-clock fa-3x text-gradient-neon mb-2"></i>
                            <h6>24/7 Available</h6>
                            <p class="small text-muted mb-0">Get fitness help anytime you need</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
/* Chat Container Styling */
.chat-messages {
    max-height: 500px;
    overflow-y: auto;
    padding: 1rem;
    background: rgba(10, 14, 39, 0.3);
    border-radius: 15px;
    scrollbar-width: thin;
}

.message {
    display: flex;
    margin-bottom: 1.5rem;
    animation: slideIn 0.3s ease-out;
}

@keyframes slideIn {
    from {
        opacity: 0;
        transform: translateY(10px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}

.message-avatar {
    width: 45px;
    height: 45px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 1.2rem;
    flex-shrink: 0;
    margin-right: 1rem;
}

.bot-message .message-avatar {
    background: linear-gradient(135deg, #6C63FF 0%, #5A52D5 100%);
    color: white;
}

.user-message .message-avatar {
    background: linear-gradient(135deg, #FF6B35 0%, #FF4500 100%);
    color: white;
    order: 2;
    margin-right: 0;
    margin-left: 1rem;
}

.message-content {
    flex: 1;
    background: rgba(20, 25, 47, 0.6);
    padding: 1rem;
    border-radius: 15px;
    backdrop-filter: blur(10px);
    border: 1px solid rgba(255, 107, 53, 0.2);
}

.user-message .message-content {
    background: rgba(255, 107, 53, 0.2);
    border: 1px solid rgba(255, 107, 53, 0.4);
}

.user-message {
    flex-direction: row-reverse;
}

/* Typing Indicator */
.typing-dots {
    display: flex;
    gap: 5px;
    padding: 10px;
}

.typing-dots span {
    width: 8px;
    height: 8px;
    background: var(--primary-orange);
    border-radius: 50%;
    animation: typing 1.4s infinite;
}

.typing-dots span:nth-child(2) {
    animation-delay: 0.2s;
}

.typing-dots span:nth-child(3) {
    animation-delay: 0.4s;
}

@keyframes typing {
    0%, 60%, 100% {
        transform: translateY(0);
        opacity: 0.5;
    }
    30% {
        transform: translateY(-10px);
        opacity: 1;
    }
}

/* Input Styling */
#user-input {
    background: rgba(20, 25, 47, 0.6);
    border: 2px solid rgba(255, 107, 53, 0.3);
    color: var(--text-primary);
    padding: 0.75rem 1rem;
}

#user-input:focus {
    background: rgba(20, 25, 47, 0.8);
    border-color: var(--primary-orange);
    color: var(--text-primary);
}

/* Quick Actions */
.quick-actions .btn {
    transition: all 0.3s ease;
}

.quick-actions .btn:hover {
    transform: translateY(-2px);
}

/* Scrollbar */
.chat-messages::-webkit-scrollbar {
    width: 6px;
}

.chat-messages::-webkit-scrollbar-track {
    background: rgba(10, 14, 39, 0.5);
    border-radius: 10px;
}

.chat-messages::-webkit-scrollbar-thumb {
    background: var(--primary-orange);
    border-radius: 10px;
}
</style>

<script>
let conversationHistory = [];

// Send message to AI coach
document.getElementById('chat-form').addEventListener('submit', async function(e) {
    e.preventDefault();
    
    const userInput = document.getElementById('user-input');
    const message = userInput.value.trim();
    
    if (!message) return;
    
    // Add user message to chat
    addMessage(message, 'user');
    
    // Clear input
    userInput.value = '';
    
    // Show typing indicator
    document.getElementById('typing-indicator').style.display = 'flex';
    
    // Scroll to bottom
    scrollToBottom();
    
    try {
        // Send to backend (ensure cookies/session are sent and handle non-JSON gracefully)
        const response = await fetch('/ai-coach/chat', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-Requested-With': 'XMLHttpRequest',
                'X-CSRFToken': '{{ csrf_token() }}'
            },
            credentials: 'same-origin',
            body: JSON.stringify({
                message: message,
                history: conversationHistory
            })
        });

        // Read raw text first to cope with redirects/non-JSON
        const raw = await response.text();
        let data;
        try {
            data = JSON.parse(raw);
        } catch (parseErr) {
            console.warn('AI Coach: Non-JSON response', { status: response.status, raw: raw?.slice(0, 300) });
            // Fall back to client-side response
            data = { success: true, response: getLocalFallbackResponse(message) };
        }
        
        // Hide typing indicator
        document.getElementById('typing-indicator').style.display = 'none';
        
        if (data.success) {
            // Add AI response to chat
            addMessage(data.response, 'bot');
            
            // Update conversation history
            conversationHistory.push(
                { role: 'user', content: message },
                { role: 'assistant', content: data.response }
            );
            
            // Limit history to last 10 messages (5 exchanges)
            if (conversationHistory.length > 10) {
                conversationHistory = conversationHistory.slice(-10);
            }
        } else {
            addMessage(data.response || getLocalFallbackResponse(message), 'bot');
        }
        
    } catch (error) {
        console.error('AI Coach Error:', error);
        document.getElementById('typing-indicator').style.display = 'none';
        // Show a smart local fallback instead of a generic connection error
        addMessage(getLocalFallbackResponse(document.getElementById('user-input').value || 'help'), 'bot');
    }
    
    scrollToBottom();
});

// Add message to chat
function addMessage(text, sender) {
    const chatContainer = document.getElementById('chat-container');
    const messageDiv = document.createElement('div');
    messageDiv.className = `message ${sender}-message`;
    
    const avatar = document.createElement('div');
    avatar.className = 'message-avatar';
    avatar.innerHTML = sender === 'user' 
        ? '<i class="fas fa-user"></i>' 
        : '<i class="fas fa-robot"></i>';
    
    const content = document.createElement('div');
    content.className = 'message-content';
    
    const name = sender === 'user' ? 'You' : 'AI Coach';
    const time = new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
    
    content.innerHTML = `
        <p class="mb-1"><strong>${name}</strong> <small class="text-muted">${time}</small></p>
        <p class="mb-0">${formatMessage(text)}</p>
    `;
    
    messageDiv.appendChild(avatar);
    messageDiv.appendChild(content);
    chatContainer.appendChild(messageDiv);
}

// Lightweight client-side fallback so the user always gets an answer
function getLocalFallbackResponse(msg) {
    const m = (msg || '').toLowerCase();
    if (/(workout|exercise|gym|train)/.test(m)) {
        return 'üí™ Try this quick full-body session:\n- 3 rounds: 12 push-ups, 15 squats, 12 dumbbell rows/side, 30s plank.\nAim 3‚Äì4 days this week. Want a plan for weight loss or muscle gain?';
    }
    if (/(food|eat|diet|nutrition|protein|calorie|meal)/.test(m)) {
        return 'ü•ó Simple nutrition wins:\n- Build plates: 1/2 veggies, 1/4 protein, 1/4 carbs + healthy fats.\n- Hit protein: ~0.8‚Äì1g/lb (1.6‚Äì2.2g/kg).\nWant a sample day meal plan?';
    }
    if (/(motivate|motivation|inspire|discipline)/.test(m)) {
        return 'üåü Momentum over motivation: show up for 10 minutes. Once you start, you‚Äôll go longer. What time tomorrow should I remind you?';
    }
    if (/(progress|plateau|faster|tips)/.test(m)) {
        return 'üìä Progress checklist:\n- Sleep 7‚Äì9h\n- Protein at each meal\n- Progressive overload\n- Track 2‚Äì3 metrics weekly.\nWant me to suggest what to track?';
    }
    return "ü§ñ I'm here to help with workouts, nutrition, motivation, and progress. Ask me for a 'workout for today' or 'nutrition tips for my goal'.";
}

// Format message text (preserve line breaks, etc.)
function formatMessage(text) {
    return text
        .replace(/\n/g, '<br>')
        .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
        .replace(/\*(.*?)\*/g, '<em>$1</em>');
}

// Scroll chat to bottom
function scrollToBottom() {
    const chatContainer = document.getElementById('chat-container');
    chatContainer.scrollTop = chatContainer.scrollHeight;
}

// Ask predefined question
function askQuestion(question) {
    document.getElementById('user-input').value = question;
    document.getElementById('chat-form').dispatchEvent(new Event('submit'));
}

// Clear chat
function clearChat() {
    if (confirm('Are you sure you want to clear the chat history?')) {
        const chatContainer = document.getElementById('chat-container');
        // Keep only the welcome message
        const messages = chatContainer.querySelectorAll('.message');
        for (let i = 1; i < messages.length; i++) {
            messages[i].remove();
        }
        conversationHistory = [];
    }
}

// Auto-focus input on load
window.addEventListener('load', function() {
    document.getElementById('user-input').focus();
});
</script>
{% endblock %}
